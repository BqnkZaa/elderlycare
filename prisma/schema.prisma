// Prisma Schema for Elderly Care Management Platform
// Database: MySQL (for Plesk hosting compatibility)

generator client {
  provider = "prisma-client-js"
  engineType = "library"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  STAFF
  NURSE
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  UNKNOWN
}

enum MobilityStatus {
  INDEPENDENT
  NEEDS_ASSISTANCE
  WHEELCHAIR
  BEDRIDDEN
}

enum CareLevel {
  LEVEL_1  // Minimal assistance
  LEVEL_2  // Moderate assistance
  LEVEL_3  // Full-time care
  LEVEL_4  // Intensive care
}

enum Mood {
  HAPPY
  CONTENT
  NEUTRAL
  SAD
  ANXIOUS
  IRRITABLE
}

enum MealIntake {
  FULL
  PARTIAL
  MINIMAL
  NONE
}

enum SleepQuality {
  EXCELLENT
  GOOD
  FAIR
  POOR
  VERY_POOR
}

// New Enums for Comprehensive Form
enum MaritalStatus {
  SINGLE
  MARRIED
  WIDOWED
  DIVORCED_SEPARATED
}

enum HearingStatus {
  NORMAL
  HARD_OF_HEARING_LEFT
  HARD_OF_HEARING_RIGHT
  HARD_OF_HEARING_BOTH
  DEAF
  HEARING_AID
}

enum VisionStatus {
  NORMAL
  NEARSIGHTED_FARSIGHTED
  CATARACT_GLAUCOMA
  GLASSES
  CONTACT_LENS
}

enum SpeechStatus {
  CLEAR
  DYSARTHRIA
  APHASIA
  NON_VERBAL
}

enum GaitStatus {
  INDEPENDENT
  UNSTEADY
  NEEDS_SUPPORT
  NON_AMBULATORY_BEDRIDDEN
}

enum BladderControl {
  CONTINENT
  OCCASIONAL_INCONTINENCE
  TOTAL_INCONTINENCE_FOLEY
}

enum BowelControl {
  NORMAL
  CONSTIPATION
  DIARRHEA
  INCONTINENCE
}

enum DiaperType {
  NONE
  TAPE
  PANTS
}

enum HealthPrivilege {
  SELF_PAY
  SOCIAL_SECURITY
  GOLD_CARD
  GOVERNMENT_OFFICER
}

enum GoalOfCare {
  REHABILITATION
  LONG_TERM_CARE
  PALLIATIVE
}

enum HomeType {
  SINGLE_HOUSE
  TOWNHOUSE
}

// ============================================
// MODELS
// ============================================

/// User model for Admin/Staff authentication
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String
  role      Role     @default(STAFF)
  status    UserStatus @default(APPROVED)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

/// ElderlyProfile model with comprehensive data for 14-section form
model ElderlyProfile {
  id        String   @id @default(uuid())
  
  // Header / Admission Info
  admissionDate         DateTime @default(now())
  admissionTime         String?   @db.VarChar(10)
  safeId                String?   @unique @db.VarChar(20)  // SIDxxx69xxx format
  partnerId             String?   @db.VarChar(20)          // PID001-PID999
  
  // Section 1: Identification & Personal Background
  firstName             String   @db.VarChar(100)
  lastName              String   @db.VarChar(100)
  nickname              String?  @db.VarChar(50)
  age                   Int?
  gender                Gender
  preferredPronouns     String?  @db.VarChar(100)
  education             String?  @db.VarChar(100)
  proudFormerOccupation String?  @db.VarChar(200)
  dateOfBirth           DateTime? // Keep for backward compatibility/calculation
  
  // Section 2: Marital Status & Contacts
  maritalStatus         MaritalStatus @default(SINGLE)
  keyCoordinatorName    String?   @db.VarChar(100)
  keyCoordinatorPhone   String?   @db.VarChar(255)
  keyCoordinatorRelation String?  @db.VarChar(100)
  legalGuardianName     String?  @db.VarChar(100)
  legalGuardianPhone    String?  @db.VarChar(255)
  legalGuardianRelation String?  @db.VarChar(100)
  
  // Section 3: Sensory & Communication
  hearingStatus         HearingStatus @default(NORMAL)
  visionStatus          VisionStatus  @default(NORMAL)
  speechStatus          SpeechStatus  @default(CLEAR)
  
  // Section 4: Mobility & Fall Risk
  historyOfFalls        Boolean  @default(false)
  fallsTimeframe        String?  @db.VarChar(50)  // 6-12 months
  fallsCause            String?  @db.Text
  gaitStatus            GaitStatus @default(INDEPENDENT)
  assistiveDevices      String?  @db.Text  // JSON array: cane, walker, wheelchair
  mobilityStatus        MobilityStatus @default(INDEPENDENT) // Keep for backward compatibility
  
  // Section 5: Elimination
  bladderControl        BladderControl @default(CONTINENT)
  foleySize             String?  @db.VarChar(10)
  bowelControl          BowelControl @default(NORMAL)
  diaperType            DiaperType @default(NONE)
  diaperSize            String?  @db.VarChar(10)
  
  // Section 6: Cognitive & Behavioral
  hasConfusion          Boolean  @default(false)
  confusionTimeframe    String?  @db.Text
  memoryStatus          String?  @db.Text  // JSON array
  behaviorStatus        String?  @db.Text  // JSON array
  
  // Section 7: Chief Complaint
  reasonForAdmission    String?   @db.Text
  initialMentalState    String?  @db.Text
  
  // Section 8: Medical History
  underlyingDiseases    String?  @db.Text
  currentMedications    String?  @db.Text
  surgicalHistory       String?  @db.Text
  
  // Section 9: Allergies
  hasDrugAllergies      Boolean  @default(false)
  drugAllergiesDetail   String?  @db.Text
  hasFoodChemicalAllergies Boolean @default(false)
  foodChemicalAllergiesDetail String? @db.Text
  allergies             String?  @db.Text // Keep for backward compatibility
  
  // Section 10: Physical & Medical Devices
  skinCondition         String?  @db.Text  // JSON array
  hasPressureUlcer      Boolean  @default(false)
  pressureUlcerLocation String?  @db.VarChar(100)
  pressureUlcerStage    String?  @db.VarChar(10) // Changed to string for input flexibility
  medicalDevices        String?  @db.Text  // JSON array
  
  // Section 11: Social Support & Financial
  primaryCaregiverName  String?  @db.VarChar(100)
  primaryCaregiverRelation String? @db.VarChar(100)
  primaryCaregiverId    String?  @db.VarChar(100) // Keep for backward compatibility
  healthPrivilege       HealthPrivilege @default(SELF_PAY)
  sponsor               String?  @db.VarChar(200)
  
  // Section 12: Religion & Beliefs
  religion              String?  @db.VarChar(100)
  religiousRestrictions String?  @db.Text
  spiritualNeeds        String?  @db.Text
  
  // Section 13: Goals & Expectations
  goalOfCare            GoalOfCare @default(LONG_TERM_CARE)
  expectationDetails    String?  @db.Text
  careLevel             CareLevel      @default(LEVEL_1)
  
  // Section 14: Environment & Genogram
  homeType              HomeType?
  bedroomLocation       String?  @db.VarChar(50)
  familyGenogram        String?  @db.Text
  
  // Address Information (Keep optional for backward compatibility/if needed)
  address               String?   @db.VarChar(255)
  subDistrict           String?   @db.VarChar(100)
  district              String?   @db.VarChar(100)
  province              String?   @db.VarChar(100)
  postalCode            String?   @db.VarChar(10)
  
  // Other existing fields
  nationalId            String?   @unique @db.VarChar(255) // Keep but make optional as we move to SAFE-ID
  phoneNumber           String?  @db.VarChar(255)
  email                 String?  @db.VarChar(255)
  emergencyContactName     String?  @db.VarChar(100)
  emergencyContactPhone    String?  @db.VarChar(255)
  emergencyContactRelation String?  @db.VarChar(50)
  bloodType             BloodType @default(UNKNOWN)
  profilePhoto          String?  @db.Text 
  specialDietaryNeeds   String?  @db.Text
  
  // System Fields
  registrationDate      DateTime @default(now())
  assessorSignature     String?  @db.VarChar(100)
  assessmentDate        DateTime?
  
  notes                 String?  @db.Text
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  dailyLogs             DailyLog[]
  appointments          Appointment[]
  scheduledActivities   ScheduledActivity[]

  // Indexes for efficient filtering
  @@index([province])
  @@index([safeId])
  @@index([registrationDate])
  @@index([isActive])
  @@map("elderly_profiles")
}

/// DailyLog model for daily health/activity tracking (One-to-Many with ElderlyProfile)
model DailyLog {
  id          String   @id @default(uuid())
  elderlyId   String
  elderly     ElderlyProfile @relation(fields: [elderlyId], references: [id], onDelete: Cascade)
  
  date        DateTime
  
  // Vital Signs (JSON object: bp_systolic, bp_diastolic, heartRate, temperature, oxygenLevel, weight)
  vitals      Json?
  
  // Daily Activity & Status
  activityNote    String?    @db.Text
  mood            Mood       @default(NEUTRAL)
  mealIntake      MealIntake @default(FULL)
  sleepQuality    SleepQuality @default(GOOD)
  sleepHours      Float?
  
  // Medication & Care
  medicationsTaken    Boolean @default(true)
  medicationNotes     String? @db.Text
  
  // Observations
  physicalCondition   String? @db.Text
  behavioralNotes     String? @db.Text
  incidentsReported   String? @db.Text
  
  // Recording Staff
  recordedBy      String   @db.VarChar(100)
  recordedByName  String?  @db.VarChar(100)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Index for efficient querying of logs by elderly and date
  @@index([elderlyId, date])
  @@index([date])
  @@map("daily_logs")
}

/// AlertLog model to track sent notifications
model AlertLog {
  id          String   @id @default(uuid())
  alertType   String   @db.VarChar(50) // BIRTHDAY, ANNIVERSARY, APPOINTMENT, ACTIVITY, MISSING_LOG
  elderlyId   String
  elderlyName String   @db.VarChar(200)
  recipientType String @db.VarChar(50) // STAFF, RELATIVE
  recipientContact String? @db.VarChar(255)
  message     String   @db.Text
  status      String   @db.VarChar(20) @default("PENDING") // PENDING, SENT, FAILED
  sentAt      DateTime?
  createdAt   DateTime @default(now())
  
  @@index([alertType, createdAt])
  @@index([elderlyId])
  @@map("alert_logs")
}

/// Appointment model for doctor visits and medical appointments
model Appointment {
  id          String   @id @default(uuid())
  elderlyId   String
  elderly     ElderlyProfile @relation(fields: [elderlyId], references: [id], onDelete: Cascade)
  
  title       String   @db.VarChar(200)  // "นัดพบแพทย์", "ตรวจเลือด"
  location    String?  @db.VarChar(200)  // โรงพยาบาล/คลินิก
  doctorName  String?  @db.VarChar(100)
  date        DateTime
  time        String?  @db.VarChar(10)   // "09:00"
  notes       String?  @db.Text
  
  remindDaysBefore Int @default(1)       // เตือนล่วงหน้ากี่วัน
  isCompleted Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([elderlyId])
  @@index([date])
  @@map("appointments")
}

/// ScheduledActivity for recurring activities
model ScheduledActivity {
  id          String   @id @default(uuid())
  elderlyId   String
  elderly     ElderlyProfile @relation(fields: [elderlyId], references: [id], onDelete: Cascade)
  
  title       String   @db.VarChar(200)  // "กายภาพบำบัด", "กินยา"
  description String?  @db.Text
  
  // Recurrence: DAILY, WEEKLY, MONTHLY
  recurrence  String   @db.VarChar(20)   @default("DAILY")
  dayOfWeek   Int?     // 0-6 for weekly (0=Sunday)
  dayOfMonth  Int?     // 1-31 for monthly
  time        String?  @db.VarChar(10)   // "08:00"
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([elderlyId])
  @@index([recurrence])
  @@map("scheduled_activities")
}

/// Review model for landing page testimonials/reviews
model Review {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(100)
  rating    Int      // 1-5 stars
  comment   String   @db.Text
  isVisible Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isVisible])
  @@index([createdAt])
  @@map("reviews")
}


/// Inquiry model for service applications/inquiries
model Inquiry {
  id        String   @id @default(uuid())
  
  // Contact Person Info
  name      String   @db.VarChar(100)
  phone     String   @db.VarChar(20)
  lineId    String?  @db.VarChar(50)
  
  // Elderly Info
  elderlyName   String?  @db.VarChar(100)
  elderlyAge    Int?
  elderlyGender String?  @db.VarChar(10) // Male, Female
  elderlyNeeds  String?  @db.Text        // Condition description
  
  message   String?  @db.Text
  status    String   @db.VarChar(20) @default("PENDING") // PENDING, CONTACTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inquiries")
}
